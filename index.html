<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Audio Training for Dummies</title>

<style>
/* --- YOUR EXISTING UI â€” UNCHANGED --- */
body {
  margin: 0;
  font-family: sans-serif;
  background: #111;
  color: #ddd;
}

#app {
  display: grid;
  grid-template-columns: 260px 1fr 260px;
  height: 100vh;
}

/* TRACK LIST */
#tracks {
  background: #1a1a1a;
  padding: 10px;
  overflow-y: auto;
}

.track {
  padding: 6px;
  border-bottom: 1px solid #333;
  cursor: pointer;
}

.track.active {
  background: #2a2a2a;
}

.track-controls {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 4px;
}

.track-controls button {
  font-size: 10px;
  width: 22px;
  height: 22px;
  background: #333;
  color: #ddd;
  border: none;
  cursor: pointer;
}

.track-controls button.muted {
  background: #b00000;
}

.track-controls button.soloed {
  background: #b0b000;
  color: #000;
}

.track-controls input[type="range"] {
  flex: 1;
}

/* EQ PANEL */
#eq-panel {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
}

canvas {
  background: #000;
  border: 1px solid #333;
  cursor: crosshair;
}

canvas.band-hover {
  cursor: grab;
}

canvas.band-dragging {
  cursor: grabbing;
}

#controls {
  margin-top: 10px;
  display: flex;
  gap: 10px;
}

button {
  background: #333;
  color: #ddd;
  border: none;
  padding: 8px 12px;
  font-size: 16px;
  cursor: pointer;
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Band type selector container */
#band-type-container {
  margin-top: 10px;
  color: #ddd;
  font-size: 14px;
}

#band-type-select {
  background: #222;
  color: #ddd;
  border: 1px solid #444;
  padding: 4px 6px;
  font-size: 14px;
  margin-left: 6px;
  cursor: pointer;
}

/* FX RACK */
#fx-rack {
  background: #1a1a1a;
  padding: 10px;
  overflow-y: auto;
}

#transport {
  margin-bottom: 10px;
}

/* Dynamics Panel */
#dynamics {
  margin-top: 20px;
  border-top: 1px solid #333;
  padding-top: 10px;
  font-size: 13px;
}

#dynamics input[type="range"] {
  width: 100%;
}
</style>
</head>

<body>
<div id="app">

  <!-- TRACKS -->
  <aside id="tracks">
    <div id="transport">
      <button id="load">Load Tracks</button>
      <button id="play">Play</button>
      <button id="stop">Stop</button>
    </div>
    <div id="track-list"></div>
  </aside>

  <!-- EQ -->
  <main id="eq-panel">
    <canvas id="eq" width="900" height="400"></canvas>
    <div id="controls">
      <button id="add-band">Add EQ Band</button>
      <button id="delete-band" disabled>Delete Selected Band</button>
    </div>
    <div id="band-type-container">
      <label for="band-type-select">Band Type:</label>
      <select id="band-type-select" disabled>
        <option value="peaking">Bell (Peaking)</option>
        <option value="lowshelf">Low Shelf</option>
        <option value="highshelf">High Shelf</option>
        <option value="lowpass">Low Pass</option>
        <option value="highpass">High Pass</option>
        <option value="notch">Notch</option>
        <option value="allpass">All Pass</option>
      </select>
    </div>
  </main>

  <!-- FX RACK -->
  <aside id="fx-rack">
    <h3>FX Rack</h3>
    <p>(Now PER-track ðŸŽ‰)</p>

    <div id="dynamics">
      <h4>Dynamics (Selected Track)</h4>

      <label>
        <input type="checkbox" id="comp-enabled" checked>
        Enable Compressor
      </label>

      <label>Threshold: <span id="threshVal">-24</span> dB</label>
      <input id="threshold" type="range" min="-100" max="0" step="1" value="-24">

      <label>Ratio: <span id="ratioVal">4</span>:1</label>
      <input id="ratio" type="range" min="1" max="20" step="1" value="4">

      <label>Attack: <span id="attackVal">0.01</span>s</label>
      <input id="attack" type="range" min="0" max="1" step="0.01" value="0.01">

      <label>Release: <span id="releaseVal">0.25</span>s</label>
      <input id="release" type="range" min="0" max="1" step="0.01" value="0.25">
    </div>

  </aside>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const audioContext = new AudioContext();
  const mixBus = audioContext.createGain();
  mixBus.connect(audioContext.destination);

  const compEnabled = document.getElementById("comp-enabled");

  const trackNames = [
    "Kick Drum","Snare Drum","Tom 1","Tom 2","Over Head",
    "Bass Guitar","Acoustic Guitar","Keyboard (Nord)",
    "Electric Guitar","Male Vocal","Female Vocal"
  ];

  const tracks = [];
  let selectedTrack = null;

  /* ============ LOAD TRACKS ============ */

  document.getElementById("load").onclick = loadTracks;

  async function loadTracks() {
    tracks.length = 0;
    document.getElementById("track-list").innerHTML = "";

    for (const name of trackNames) {
      const res = await fetch(`audio/${name}.wav`);
      const buffer = await audioContext.decodeAudioData(await res.arrayBuffer());

      const eqInput = audioContext.createGain();
      const eqOutput = audioContext.createGain();

      const compressor = audioContext.createDynamicsCompressor();
      compressor.threshold.value = -24;
      compressor.ratio.value = 4;
      compressor.attack.value = 0.01;
      compressor.release.value = 0.25;

      const gainNode = audioContext.createGain();
      gainNode.gain.value = 1;

      // routing
      eqInput.connect(eqOutput);
      eqOutput.connect(compressor);
      compressor.connect(gainNode);
      gainNode.connect(mixBus);

      tracks.push({
        name,
        buffer,
        source: null,
        eqInput,
        eqOutput,
        compressor,
        gainNode,
        eqBands: [],
        muted: false,
        solo: false,
        compBypassed: false
      });
    }

    buildTrackUI();
    selectedTrack = tracks[0];
    refreshCompressorUI();
    setSelectedBand(null);
  }

  /* ============ TRACK UI ============ */

  function buildTrackUI() {
    const list = document.getElementById("track-list");
    list.innerHTML = "";

    tracks.forEach(track => {
      const row = document.createElement("div");
      row.className = "track";
      row.textContent = track.name;

      row.onclick = () => {
        document.querySelectorAll(".track").forEach(t => t.classList.remove("active"));
        row.classList.add("active");
        selectedTrack = track;
        refreshCompressorUI();
        setSelectedBand(null);
      };

      const controls = document.createElement("div");
      controls.className = "track-controls";

      const mute = document.createElement("button");
      mute.textContent = "M";
      mute.onclick = e => {
        e.stopPropagation();
        track.muted = !track.muted;
        mute.classList.toggle("muted", track.muted);
        updateMuteSolo();
      };

      const solo = document.createElement("button");
      solo.textContent = "S";
      solo.onclick = e => {
        e.stopPropagation();
        track.solo = !track.solo;
        solo.classList.toggle("soloed", track.solo);
        updateMuteSolo();
      };

      const fader = document.createElement("input");
      fader.type = "range";
      fader.min = 0;
      fader.max = 1;
      fader.step = 0.01;
      fader.value = 0.75;
      fader.oninput = () => track.gainNode.gain.value = fader.value;

      controls.append(mute, solo, fader);
      row.appendChild(controls);
      list.appendChild(row);
    });

    document.querySelector(".track")?.classList.add("active");
  }

  function updateMuteSolo() {
    const anySolo = tracks.some(t => t.solo);
    tracks.forEach(t => {
      if (anySolo) {
        t.gainNode.gain.value = t.solo && !t.muted ? 1 : 0;
      } else {
        t.gainNode.gain.value = t.muted ? 0 : 1;
      }
    });
  }

  /* ============ LOOPING PLAYBACK ============ */

  document.getElementById("play").onclick = play;
  document.getElementById("stop").onclick = stop;
  document.body.onclick = () => audioContext.resume();

  function play() {
    stop();
    tracks.forEach(track => {
      const src = audioContext.createBufferSource();
      src.buffer = track.buffer;
      src.loop = true;
      src.connect(track.eqInput);
      src.start();
      track.source = src;
    });
  }

  function stop() {
    tracks.forEach(track => {
      if (track.source) {
        try { track.source.stop(); } catch(e){}
        track.source = null;
      }
    });
  }

  /* ============ COMPRESSOR UI BINDS PER TRACK ============ */

  const thresholdEl = document.getElementById("threshold");
  const ratioEl = document.getElementById("ratio");
  const attackEl = document.getElementById("attack");
  const releaseEl = document.getElementById("release");

  const threshVal = document.getElementById("threshVal");
  const ratioVal = document.getElementById("ratioVal");
  const attackVal = document.getElementById("attackVal");
  const releaseVal = document.getElementById("releaseVal");

  compEnabled.addEventListener("change", () => {
    if (!selectedTrack) return;
    selectedTrack.compBypassed = !compEnabled.checked;
    updateTrackCompressorRouting(selectedTrack);
  });

  function updateTrackCompressorRouting(track) {
    try { track.eqOutput.disconnect(); } catch(e){}
    if (track.compBypassed) {
      track.eqOutput.connect(track.gainNode);
    } else {
      track.eqOutput.connect(track.compressor);
    }
  }

  function bindRange(input, label, paramName) {
    input.addEventListener("input", () => {
      if (!selectedTrack) return;
      selectedTrack.compressor[paramName].value = parseFloat(input.value);
      label.textContent = input.value;
    });
  }

  bindRange(thresholdEl, threshVal, "threshold");
  bindRange(ratioEl, ratioVal, "ratio");
  bindRange(attackEl, attackVal, "attack");
  bindRange(releaseEl, releaseVal, "release");

  function refreshCompressorUI() {
    if (!selectedTrack) return;

    threshVal.textContent = thresholdEl.value = selectedTrack.compressor.threshold.value.toFixed(0);
    ratioVal.textContent = ratioEl.value = selectedTrack.compressor.ratio.value.toFixed(0);
    attackVal.textContent = attackEl.value = selectedTrack.compressor.attack.value.toFixed(2);
    releaseVal.textContent = releaseEl.value = selectedTrack.compressor.release.value.toFixed(2);

    compEnabled.checked = !selectedTrack.compBypassed;
  }

});
</script>

</body>
</html>
