<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Audio Training Mixer</title>

<style>
body{
  background:#1a1a1a;
  color:white;
  font-family:Arial;
  display:flex;
  gap:20px;
  padding:20px;
}

.sidebar{
  width:260px;
  background:#222;
  padding:10px;
  border-radius:10px;
}

.track{
  padding:8px;
  border-radius:8px;
  background:#2c2c2c;
  margin-bottom:8px;
  cursor:pointer;
}

.track.selected{
  outline:2px solid #4da3ff;
}

.controls button{
  margin-right:10px;
}

.fx-box{
  margin-top:20px;
  background:#2b2b2b;
  padding:12px;
  border-radius:10px;
}
.fx-box select{
  width:100%;
  margin-top:8px;
}
</style>
</head>

<body>

<div class="sidebar">
  <h3>Tracks</h3>
  <div id="trackList"></div>

  <div class="controls">
    <button id="play">PLAY</button>
    <button id="stop">STOP</button>
  </div>

  <div class="fx-box">
    <h3>Dynamics Rack (Track-Based)</h3>

    <label>Processor 1</label>
    <select id="dyn1">
      <option value="none">None</option>
      <option value="comp">Compressor</option>
      <option value="gate">Gate</option>
    </select>

    <label>Processor 2</label>
    <select id="dyn2">
      <option value="none">None</option>
      <option value="comp">Compressor</option>
      <option value="gate">Gate</option>
    </select>

  </div>
</div>


<canvas id="eqCanvas" width="900" height="450" style="background:#111;border-radius:10px"></canvas>

<script>
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

const trackFiles = [
 "Kick Drum.wav",
 "Snare Drum.wav",
 "Tom 1.wav",
 "Tom 2.wav",
 "Over Head.wav",
 "Bass Guitar.wav",
 "Acoustic Guitar.wav",
 "Keyboard (Nord).wav",
 "Electric Guitar.wav",
 "Male Vocal.wav",
 "Female Vocal.wav"
];

let tracks = [];
let selectedTrack = null;

async function loadTracks(){
  for (let name of trackFiles){
    let res = await fetch("audio/"+name);
    let arr = await res.arrayBuffer();
    let buf = await audioContext.decodeAudioData(arr);

    tracks.push({
      name,
      buffer:buf,
      source:null,
      gain:audioContext.createGain(),
      dyn1:"none",
      dyn2:"none"
    });
  }
  renderTracks();
}

function renderTracks(){
  let div = document.getElementById("trackList");
  div.innerHTML="";
  tracks.forEach((t,i)=>{
    let el = document.createElement("div");
    el.className="track"+(selectedTrack===t?" selected":"");
    el.innerText=t.name;
    el.onclick=()=>{
      selectedTrack=t;
      renderTracks();
      loadFXUI();
    };
    div.appendChild(el);
  });
}

function loadFXUI(){
  if(!selectedTrack)return;
  document.getElementById("dyn1").value = selectedTrack.dyn1;
  document.getElementById("dyn2").value = selectedTrack.dyn2;
}

// === DYNAMICS NODES ===
function applyDynamics(track,input){
  let node = input;

  function makeComp(){
    let c = audioContext.createDynamicsCompressor();
    c.threshold.value=-24;
    c.ratio.value=4;
    return c;
  }

  function makeGate(){
    let g = audioContext.createBiquadFilter();
    g.type="highpass";
    g.frequency.value=120;
    return g;
  }

  if(track.dyn1==="comp") node=node.connect(makeComp());
  else if(track.dyn1==="gate") node=node.connect(makeGate());

  if(track.dyn2==="comp") node=node.connect(makeComp());
  else if(track.dyn2==="gate") node=node.connect(makeGate());

  return node;
}

// === PLAYBACK ===
async function play(){
  await audioContext.resume();

  stop();

  tracks.forEach(track=>{
    const src = audioContext.createBufferSource();
    src.buffer = track.buffer;
    src.loop = true;

    let chain = src;

    chain = applyDynamics(track,chain);

    chain.connect(track.gain).connect(audioContext.destination);

    src.start();
    track.source = src;
  });
}

function stop(){
  tracks.forEach(t=>{
    if(t.source){
      try{ t.source.stop(); }catch(e){}
      t.source=null;
    }
  });
}

// === FX UI ===
document.getElementById("dyn1").onchange=e=>{
  if(selectedTrack){
    selectedTrack.dyn1=e.target.value;
  }
};
document.getElementById("dyn2").onchange=e=>{
  if(selectedTrack){
    selectedTrack.dyn2=e.target.value;
  }
};

document.getElementById("play").onclick=play;
document.getElementById("stop").onclick=stop;

// Load tracks at start
loadTracks();

</script>
</body>
</html>
