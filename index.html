<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Multitrack EQ Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #1e1e1e;
  color: #eee;
}

#app {
  display: grid;
  grid-template-columns: 260px 1fr 280px;
  height: calc(100vh - 60px);
}

aside, main {
  padding: 10px;
  border-right: 1px solid #333;
  overflow-y: auto;
}

canvas {
  background: #111;
  border: 1px solid #444;
}

.track {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
  cursor: pointer;
}

.track.active {
  background: #333;
}

.track label {
  width: 110px;
  font-size: 12px;
}

input[type=range] {
  flex: 1;
}

button {
  background: #333;
  color: white;
  border: none;
  padding: 6px 10px;
  cursor: pointer;
  border-radius: 4px;
}

button:hover {
  background: #555;
}

footer {
  height: 60px;
  background: #111;
  border-top: 1px solid #333;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
}
</style>
</head>

<body>
<div id="app">

<!-- TRACK LIST -->
<aside>
  <h3>Tracks</h3>
  <div id="track-list"></div>
  <button id="load">Load Tracks</button>
</aside>

<!-- EQ PANEL -->
<main style="display:flex; flex-direction:column; align-items:center;">
  <canvas id="eq" width="900" height="400"></canvas>
  <button id="add-band" style="margin-top:10px;">Add EQ Band</button>
</main>

<!-- EQ CONTROLS -->
<aside>
  <h3 id="eq-title">Select a Track</h3>
  <div id="bands"></div>
</aside>

</div>

<footer>
  <button id="play">Play</button>
  <button id="stop">Stop</button>
</footer>

<script type="module">
/* ======================================================
   AUDIO CONTEXT & MIX BUS
====================================================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const master = audioCtx.createGain();
const analyser = audioCtx.createAnalyser();
const mixBus = audioCtx.createGain();

mixBus.connect(analyser);
analyser.connect(master);
master.connect(audioCtx.destination);

analyser.fftSize = 2048;
const spectrum = new Uint8Array(analyser.frequencyBinCount);

/* ======================================================
   TRACK DEFINITIONS
====================================================== */
const trackNames = [
  "Kick Drum",
  "Snare Drum",
  "Tom 1",
  "Tom 2",
  "Over Head",
  "Bass Guitar",
  "Acoustic Guitar",
  "Keyboard (Nord)",
  "Electric Guitar",
  "Male Vocal",
  "Female Vocal"
];

const tracks = [];
let selectedTrack = null;

/* ======================================================
   LOAD TRACKS
====================================================== */
async function loadTracks() {
  tracks.length = 0;
  document.getElementById("track-list").innerHTML = "";

  for (const name of trackNames) {
    const res = await fetch(`./audio/${name}.wav`);
    const buf = await audioCtx.decodeAudioData(await res.arrayBuffer());

    const eqIn = audioCtx.createGain();
    const eqOut = audioCtx.createGain();
    eqIn.connect(eqOut);

    const gain = audioCtx.createGain();
    gain.gain.value = 0.8;

    eqOut.connect(gain);
    gain.connect(mixBus);

    tracks.push({
      name,
      buffer: buf,
      source: null,
      gain,
      eqIn,
      eqOut,
      eqBands: []
    });
  }

  buildTrackUI();
  alert("Tracks loaded!");
}

/* ======================================================
   PLAYBACK
====================================================== */
function playAll() {
  if (audioCtx.state === "suspended") audioCtx.resume();
  stopAll();

  tracks.forEach(t => {
    const src = audioCtx.createBufferSource();
    src.buffer = t.buffer;
    src.loop = true;
    src.connect(t.eqIn);
    t.source = src;
    src.start();
  });
}

function stopAll() {
  tracks.forEach(t => {
    if (t.source) {
      t.source.stop();
      t.source.disconnect();
      t.source = null;
    }
  });
}

/* ======================================================
   TRACK UI
====================================================== */
function buildTrackUI() {
  const list = document.getElementById("track-list");
  list.innerHTML = "";

  tracks.forEach(track => {
    const row = document.createElement("div");
    row.className = "track";

    const label = document.createElement("label");
    label.textContent = track.name;

    const fader = document.createElement("input");
    fader.type = "range";
    fader.min = 0;
    fader.max = 1;
    fader.step = 0.01;
    fader.value = track.gain.gain.value;

    fader.oninput = () => {
      track.gain.gain.value = fader.value;
    };

    row.onclick = () => selectTrack(track, row);

    row.append(label, fader);
    list.appendChild(row);
  });
}

function selectTrack(track, row) {
  document.querySelectorAll(".track").forEach(t => t.classList.remove("active"));
  row.classList.add("active");

  selectedTrack = track;
  document.getElementById("eq-title").textContent = track.name + " EQ";
  updateBandUI();
}

/* ======================================================
   EQ
====================================================== */
function rebuildEQ(track) {
  track.eqIn.disconnect();
  track.eqBands.forEach(b => b.node.disconnect());

  let node = track.eqIn;
  track.eqBands.forEach(b => {
    node.connect(b.node);
    node = b.node;
  });

  node.connect(track.eqOut);
}

function addEQBand() {
  if (!selectedTrack) return;

  const node = audioCtx.createBiquadFilter();
  node.type = "peaking";
  node.frequency.value = 1000;
  node.gain.value = 0;
  node.Q.value = 1;

  selectedTrack.eqBands.push({ node });
  rebuildEQ(selectedTrack);
  updateBandUI();
}

/* ======================================================
   EQ BAND UI
====================================================== */
function updateBandUI() {
  const panel = document.getElementById("bands");
  panel.innerHTML = "";

  if (!selectedTrack) return;

  selectedTrack.eqBands.forEach((band, i) => {
    const div = document.createElement("div");

    const type = document.createElement("select");
    ["peaking","lowshelf","highshelf","lowpass","highpass"].forEach(t => {
      const o = document.createElement("option");
      o.value = t;
      o.textContent = t;
      if (band.node.type === t) o.selected = true;
      type.appendChild(o);
    });
    type.onchange = () => band.node.type = type.value;

    const remove = document.createElement("button");
    remove.textContent = "Remove";
    remove.onclick = () => {
      selectedTrack.eqBands.splice(i,1);
      rebuildEQ(selectedTrack);
      updateBandUI();
    };

    div.append(type, remove);
    panel.appendChild(div);
  });
}

/* ======================================================
   EQ GRAPH + ANALYZER
====================================================== */
const canvas = document.getElementById("eq");
const ctx = canvas.getContext("2d");

const FMIN = 20, FMAX = 20000;
const GMIN = -24, GMAX = 24;

function fx(freq) {
  return Math.log10(freq / FMIN) / Math.log10(FMAX / FMIN) * canvas.width;
}
function fy(db) {
  db = Math.max(GMIN, Math.min(GMAX, db));
  return canvas.height - (db - GMIN) / (GMAX - GMIN) * canvas.height;
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = "#111";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  analyser.getByteFrequencyData(spectrum);
  ctx.fillStyle = "#4caf50";
  spectrum.forEach((v,i)=>{
    const x=i/spectrum.length*canvas.width;
    ctx.fillRect(x, canvas.height, 1, -v/255*canvas.height);
  });

  if (selectedTrack) {
    ctx.beginPath();
    ctx.strokeStyle = "#ff4081";
    for (let x=0;x<canvas.width;x++) {
      const freq = FMIN * Math.pow(FMAX/FMIN, x/canvas.width);
      let mag = 1;
      selectedTrack.eqBands.forEach(b=>{
        const f=new Float32Array([freq]);
        const m=new Float32Array(1);
        b.node.getFrequencyResponse(f,m,new Float32Array(1));
        mag*=m[0];
      });
      const y = fy(20*Math.log10(mag));
      x===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  requestAnimationFrame(draw);
}
draw();

/* ======================================================
   BUTTONS
====================================================== */
document.getElementById("load").onclick = loadTracks;
document.getElementById("play").onclick = playAll;
document.getElementById("stop").onclick = stopAll;
document.getElementById("add-band").onclick = addEQBand;
</script>
</body>
</html>
