<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Audio Training Console</title>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #111;
  color: #ddd;
}

#app {
  display: grid;
  grid-template-columns: 260px 1fr;
  height: 100vh;
}

aside {
  background: #1a1a1a;
  padding: 10px;
  overflow-y: auto;
}

button, select, input {
  width: 100%;
  margin-bottom: 4px;
}

.track {
  padding: 6px;
  cursor: pointer;
  border-bottom: 1px solid #333;
}

.track.active {
  background: #333;
}

main {
  padding: 10px;
}

canvas {
  background: #000;
  border: 1px solid #333;
  width: 100%;
}

.section {
  margin-top: 10px;
  padding: 8px;
  background: #1a1a1a;
  border: 1px solid #333;
}

.param {
  margin-top: 6px;
}

label {
  font-size: 11px;
}

.gr-meter {
  height: 8px;
  background: #222;
  border: 1px solid #444;
}

.gr-fill {
  height: 100%;
  width: 0%;
  background: #00ff88;
}
</style>
</head>

<body>
<div id="app">

<aside>
  <button id="load">Load Tracks</button>
  <button id="play">Play</button>
  <button id="stop">Stop</button>
  <div id="track-list"></div>
</aside>

<main>
  <canvas id="eq" width="900" height="250"></canvas>

  <!-- YOUR EQ CONTROLS (UNCHANGED) -->
  <div class="section">
    <h3>EQ</h3>
    <div id="eq-controls"></div>
    <button id="add-band">Add EQ Band</button>
  </div>

  <!-- DYNAMICS A -->
  <div class="section">
    <h3>Dynamics A</h3>
    <select id="dynA-type">
      <option value="off">Off</option>
      <option value="compressor">Compressor</option>
      <option value="limiter">Limiter</option>
      <option value="gate">Gate</option>
      <option value="expander">Expander</option>
      <option value="deesser">De-Esser</option>
    </select>
    <select id="dynA-pos">
      <option value="pre">Pre-EQ</option>
      <option value="post">Post-EQ</option>
    </select>

    <label>Threshold</label><input id="dynA-th" type="range" min="-80" max="0" value="-18">
    <label>Ratio</label><input id="dynA-ra" type="range" min="0.2" max="20" step="0.1" value="4">
    <label>Attack (ms)</label><input id="dynA-at" type="range" min="1" max="100" value="10">
    <label>Release (ms)</label><input id="dynA-re" type="range" min="20" max="500" value="120">
    <label>Makeup</label><input id="dynA-mu" type="range" min="0" max="12" step="0.5">

    <div class="gr-meter"><div id="grA" class="gr-fill"></div></div>
  </div>

  <!-- DYNAMICS B -->
  <div class="section">
    <h3>Dynamics B</h3>
    <select id="dynB-type">
      <option value="off">Off</option>
      <option value="compressor">Compressor</option>
      <option value="limiter">Limiter</option>
      <option value="gate">Gate</option>
      <option value="expander">Expander</option>
      <option value="deesser">De-Esser</option>
    </select>
    <select id="dynB-pos">
      <option value="pre">Pre-EQ</option>
      <option value="post">Post-EQ</option>
    </select>

    <label>Threshold</label><input id="dynB-th" type="range" min="-80" max="0" value="-18">
    <label>Ratio</label><input id="dynB-ra" type="range" min="0.2" max="20" step="0.1" value="4">
    <label>Attack (ms)</label><input id="dynB-at" type="range" min="1" max="100" value="10">
    <label>Release (ms)</label><input id="dynB-re" type="range" min="20" max="500" value="120">
    <label>Makeup</label><input id="dynB-mu" type="range" min="0" max="12" step="0.5">

    <div class="gr-meter"><div id="grB" class="gr-fill"></div></div>
  </div>

</main>
</div>

<script>
const ctx = new AudioContext();
const mixBus = ctx.createGain();
mixBus.connect(ctx.destination);

const tracks = [];
let selectedTrack = null;

/* ================================
   LOAD TRACKS
================================ */
document.getElementById("load").onclick = async () => {
  tracks.length = 0;
  document.getElementById("track-list").innerHTML = "";

  const res = await fetch("audio/Track1.wav");
  const buffer = await ctx.decodeAudioData(await res.arrayBuffer());

  const eqInput = ctx.createGain();
  const eqOutput = ctx.createGain();
  eqInput.connect(eqOutput);

  // === DYNAMICS NODES ===
  const dynA = ctx.createDynamicsCompressor();
  const dynB = ctx.createDynamicsCompressor();
  const makeupA = ctx.createGain();
  const makeupB = ctx.createGain();
  const fader = ctx.createGain();

  eqOutput.connect(dynB);
  dynB.connect(makeupB);
  makeupB.connect(fader);
  fader.connect(mixBus);

  tracks.push({
    buffer,
    eqInput,
    eqOutput,
    dynA,
    dynB,
    makeupA,
    makeupB,
    dynApos: "pre",
    dynBpos: "post",
    dynAtype: "off",
    dynBtype: "off",
    fader
  });

  buildTrackUI();
  selectTrack(tracks[0]);
};

/* ================================
   TRACK UI
================================ */
function buildTrackUI() {
  const list = document.getElementById("track-list");
  tracks.forEach(t => {
    const d = document.createElement("div");
    d.className = "track active";
    d.textContent = "Track 1";
    d.onclick = () => selectTrack(t, d);
    list.appendChild(d);
  });
}

function selectTrack(t, row) {
  document.querySelectorAll(".track").forEach(e => e.classList.remove("active"));
  row?.classList.add("active");
  selectedTrack = t;
}

/* ================================
   PLAYBACK
================================ */
document.getElementById("play").onclick = () => {
  tracks.forEach(t => {
    const s = ctx.createBufferSource();
    s.buffer = t.buffer;
    s.connect(t.eqInput);
    s.start();
  });
};

document.getElementById("stop").onclick = () => location.reload();

/* ================================
   DYNAMICS CONTROL
================================ */
function applyDynamics(slot) {
  if (!selectedTrack) return;

  const isA = slot === "A";
  const dyn = isA ? selectedTrack.dynA : selectedTrack.dynB;
  const makeup = isA ? selectedTrack.makeupA : selectedTrack.makeupB;

  const th = document.getElementById(`dyn${slot}-th`).value;
  const ra = document.getElementById(`dyn${slot}-ra`).value;
  const at = document.getElementById(`dyn${slot}-at`).value / 1000;
  const re = document.getElementById(`dyn${slot}-re`).value / 1000;
  const mu = document.getElementById(`dyn${slot}-mu`).value;

  dyn.threshold.value = th;
  dyn.ratio.value = ra;
  dyn.attack.value = at;
  dyn.release.value = re;
  makeup.gain.value = Math.pow(10, mu / 20);
}

["A","B"].forEach(slot => {
  ["th","ra","at","re","mu"].forEach(p => {
    document.getElementById(`dyn${slot}-${p}`).oninput = () => applyDynamics(slot);
  });
});

/* ================================
   GR METERS
================================ */
function meters() {
  requestAnimationFrame(meters);
  if (!selectedTrack) return;
  document.getElementById("grA").style.width =
    Math.min(Math.abs(selectedTrack.dynA.reduction) / 20, 1) * 100 + "%";
  document.getElementById("grB").style.width =
    Math.min(Math.abs(selectedTrack.dynB.reduction) / 20, 1) * 100 + "%";
}
meters();
</script>
</body>
</html>
