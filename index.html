<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Audio Training EQ + Dynamics</title>
<style>
  body {
    font-family: monospace, monospace;
    background: #111;
    color: #eee;
    margin: 0; padding: 0;
    display: flex;
    height: 100vh;
  }
  #track-list {
    width: 180px;
    background: #222;
    overflow-y: auto;
    padding: 10px;
    box-sizing: border-box;
  }
  .track {
    padding: 6px;
    margin-bottom: 4px;
    background: #333;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
  }
  .track.active {
    background: #0a0;
    font-weight: bold;
  }
  .track button {
    margin-left: auto;
    margin-right: 4px;
    cursor: pointer;
    width: 28px;
    height: 24px;
    font-weight: bold;
    border: none;
    border-radius: 4px;
    color: #eee;
    background: #444;
    transition: background-color 0.2s ease;
  }
  .track button:hover {
    background: #666;
  }
  .mute-button.muted {
    background: #a00 !important;
  }
  .solo-button.soloed {
    background: #aa0 !important;
    color: #222 !important;
  }
  .volume-slider {
    width: 60px;
    margin-left: 6px;
  }
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }
  canvas {
    background: #000;
    width: 100%;
    height: 300px;
    border: 1px solid #555;
    user-select: none;
  }
  #controls {
    margin-top: 10px;
  }
  button {
    background: #222;
    border: 1px solid #444;
    color: #eee;
    padding: 6px 12px;
    margin-right: 6px;
    cursor: pointer;
    border-radius: 4px;
  }
  button:disabled {
    color: #555;
    border-color: #222;
    cursor: default;
  }
  #dynamic-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
  }
  .dynamic-box {
    background: #222;
    border-radius: 6px;
    padding: 12px;
    flex: 1;
    min-width: 280px;
    font-size: 14px;
  }
  .dynamic-box h4 {
    margin: 0 0 10px 0;
  }
  label {
    display: block;
    margin-bottom: 8px;
    cursor: pointer;
  }
  select {
    width: 100%;
    padding: 4px;
    background: #111;
    border: 1px solid #444;
    color: #eee;
    border-radius: 4px;
    font-family: monospace, monospace;
  }
</style>
</head>
<body>

<div id="track-list">
  <button id="load-tracks">Load Tracks</button>
</div>

<div id="main">
  <canvas id="eq-canvas" width="800" height="300"></canvas>
  <div id="controls">
    <button id="play-button" disabled>Play</button>
    <button id="stop-button" disabled>Stop</button>
    <button id="add-band" disabled>Add EQ Band</button>
    <button id="delete-band" disabled>Delete EQ Band</button>
    <label style="margin-left:20px; user-select:none;">
      Band Type:
      <select id="band-type-select" disabled>
        <option value="peaking">Bell</option>
        <option value="lowshelf">Low Shelf</option>
        <option value="highshelf">High Shelf</option>
        <option value="lpf">Low Pass Filter</option>
        <option value="hpf">High Pass Filter</option>
      </select>
    </label>
  </div>

  <div id="dynamic-container">
    <div class="dynamic-box" id="dynamic1">
      <h4>Dynamic Processor 1</h4>
      <label>
        Position:
        <select class="dyn-position">
          <option value="pre">Pre EQ</option>
          <option value="post">Post EQ</option>
        </select>
      </label>
      <label>
        Processor:
        <select class="dyn-type">
          <option value="bypass">Bypass</option>
          <option value="gate">Gate</option>
          <option value="compressor">Compressor</option>
          <option value="deesser">De-Esser</option>
          <option value="expander">Expander</option>
          <option value="limiter">Limiter</option>
        </select>
      </label>
    </div>

    <div class="dynamic-box" id="dynamic2">
      <h4>Dynamic Processor 2</h4>
      <label>
        Position:
        <select class="dyn-position">
          <option value="pre">Pre EQ</option>
          <option value="post">Post EQ</option>
        </select>
      </label>
      <label>
        Processor:
        <select class="dyn-type">
          <option value="bypass">Bypass</option>
          <option value="gate">Gate</option>
          <option value="compressor">Compressor</option>
          <option value="deesser">De-Esser</option>
          <option value="expander">Expander</option>
          <option value="limiter">Limiter</option>
        </select>
      </label>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();

  const audioFiles = [
    "Kick Drum",
    "Snare Drum",
    "Tom 1",
    "Tom 2",
    "Over Head",
    "Bass Guitar",
    "Acoustic Guitar",
    "Keyboard (Nord)",
    "Electric Guitar",
    "Male Vocal",
    "Female Vocal"
  ];

  const FREQ_MIN = 20;
  const FREQ_MAX = 20000;
  const GAIN_MIN = -24;
  const GAIN_MAX = 24;

  // DOM elements
  const trackListEl = document.getElementById("track-list");
  const loadTracksBtn = document.getElementById("load-tracks");
  const playBtn = document.getElementById("play-button");
  const stopBtn = document.getElementById("stop-button");
  const addBandBtn = document.getElementById("add-band");
  const deleteBandBtn = document.getElementById("delete-band");
  const bandTypeSelect = document.getElementById("band-type-select");
  const canvas = document.getElementById("eq-canvas");
  const ctx = canvas.getContext("2d");

  const dynBoxes = [
    document.getElementById("dynamic1"),
    document.getElementById("dynamic2"),
  ];

  let tracks = [];
  let selectedTrack = null;
  let selectedBand = null;
  let draggingBand = null;

  class Track {
    constructor(name) {
      this.name = name;
      this.buffer = null;
      this.source = null;
      this.gainNode = audioContext.createGain();
      this.muted = false;
      this.soloed = false;
      this.eqBands = [];
      this.dynamics = [
        { position: "pre", type: "bypass", node: null },
        { position: "post", type: "bypass", node: null },
      ];
      this.playing = false;
    }

    async load() {
      const urlName = this.name.replace(/[ ()]/g, "") + ".wav";
      const url = `audio/${urlName}`;
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      this.buffer = await audioContext.decodeAudioData(arrayBuffer);
    }

    play() {
      if (!this.buffer) return;
      this.source = audioContext.createBufferSource();
      this.source.buffer = this.buffer;
      this.buildAudioGraph();
      this.source.start();
      this.playing = true;
      this.source.onended = () => {
        this.playing = false;
        if (selectedTrack === this) {
          playBtn.disabled = false;
          stopBtn.disabled = true;
        }
      };
    }

    stop() {
      if (this.source) {
        this.source.stop();
        this.source.disconnect();
        this.source = null;
      }
      this.playing = false;
    }

    buildAudioGraph() {
      if (this.source) this.source.disconnect();

      // Disconnect all
      this.eqBands.forEach(band => band.node && band.node.disconnect());
      this.dynamics.forEach(dyn => dyn.node && dyn.node.disconnect());
      this.gainNode.disconnect();

      // Setup EQ nodes for each band
      this.eqBands.forEach(band => {
        if (!band.node) band.node = audioContext.createBiquadFilter();
        band.node.type = band.type === "lpf" ? "lowpass" :
                        band.type === "hpf" ? "highpass" :
                        band.type;
        band.node.frequency.value = band.freq;
        band.node.gain.value = band.gain;
        band.node.Q.value = band.Q;
      });

      // Setup dynamic nodes (stub as bypass)
      this.dynamics.forEach(dyn => {
        if (dyn.node) dyn.node.disconnect();
        dyn.node = createDynNode(dyn.type);
      });

      // Connect nodes based on positions
      // Source -> pre dynamics -> EQ -> post dynamics -> gain -> destination
      let nodeChain = this.source;

      // Pre dynamics
      this.dynamics.filter(d => d.position === "pre" && d.type !== "bypass").forEach(dyn => {
        nodeChain.connect(dyn.node);
        nodeChain = dyn.node;
      });

      // EQ chain
      this.eqBands.forEach(band => {
        nodeChain.connect(band.node);
        nodeChain = band.node;
      });

      // Post dynamics
      this.dynamics.filter(d => d.position === "post" && d.type !== "bypass").forEach(dyn => {
        nodeChain.connect(dyn.node);
        nodeChain = dyn.node;
      });

      // Finally to gain node and destination
      nodeChain.connect(this.gainNode);
      this.gainNode.connect(audioContext.destination);

      // Mute handling
      this.gainNode.gain.value = this.muted ? 0 : 1;
    }

    updateAudioGraph() {
      if (!this.source) return;
      this.buildAudioGraph();
    }
  }

  function createDynNode(type) {
    // Stub nodes: bypass = gain 1, others are gain 1 for now
    const gainNode = audioContext.createGain();
    gainNode.gain.value = 1;
    return gainNode;
  }

  function freqToX(freq) {
    const logMin = Math.log10(FREQ_MIN);
    const logMax = Math.log10(FREQ_MAX);
    const logFreq = Math.log10(freq);
    return (logFreq - logMin) / (logMax - logMin) * canvas.width;
  }

  function xToFreq(x) {
    const logMin = Math.log10(FREQ_MIN);
    const logMax = Math.log10(FREQ_MAX);
    const logFreq = x / canvas.width * (logMax - logMin) + logMin;
    return Math.pow(10, logFreq);
  }

  function gainToY(gain) {
    // gain in dB, canvas y 0=top (24dB), bottom= -24dB
    return (GAIN_MAX - gain) / (GAIN_MAX - GAIN_MIN) * canvas.height;
  }

  function yToGain(y) {
    return GAIN_MAX - (y / canvas.height) * (GAIN_MAX - GAIN_MIN);
  }

  function drawGrid() {
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = "#444";
    ctx.lineWidth = 1;

    // Vertical freq lines (log spaced)
    const freqs = [20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000];
    ctx.font = "10px monospace";
    ctx.fillStyle = "#666";
    ctx.textAlign = "center";
    freqs.forEach(f => {
      const x = freqToX(f);
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, canvas.height);
      ctx.stroke();
      ctx.fillText(f + " Hz", x, canvas.height - 4);
    });

    // Horizontal gain lines
    const gains = [GAIN_MIN, -12, 0, 12, GAIN_MAX];
    ctx.textAlign = "right";
    gains.forEach(g => {
      const y = gainToY(g);
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width, y);
      ctx.stroke();
      ctx.fillText(g + " dB", canvas.width - 4, y - 2);
    });
  }

  function drawEQ() {
    drawGrid();

    if (!selectedTrack) return;

    // Frequency response curve
    const eqResponse = new Array(canvas.width).fill(1);

    for (let i = 0; i < canvas.width; i++) {
      let freq = xToFreq(i);
      let mag = 1;

      selectedTrack.eqBands.forEach(band => {
        const f0 = band.freq;
        const gain = band.gain;
        const Q = band.Q || 1;
        const bw = f0 / Q;
        const deltaF = Math.abs(freq - f0);
        const x = deltaF / bw;
        const peak = Math.pow(10, gain / 40);
        mag *= 1 + (peak - 1) * Math.exp(-x * x * 4);
      });

      eqResponse[i] = mag;
    }

    // Draw frequency response
    ctx.beginPath();
    ctx.strokeStyle = "#0f0";
    for (let i = 0; i < canvas.width; i++) {
      const mag = eqResponse[i];
      const y = gainToY(20 * Math.log10(mag));
      if (i === 0) ctx.moveTo(i, y);
      else ctx.lineTo(i, y);
    }
    ctx.stroke();

    // Draw EQ bands
    selectedTrack.eqBands.forEach((band, i) => {
      const x = freqToX(band.freq);
      const y = gainToY(band.gain);

      ctx.fillStyle = (i === selectedBand) ? "#ff0" : "#0f0";
      ctx.beginPath();
      ctx.arc(x, y, 7, 0, Math.PI * 2);
      ctx.fill();
      if (i === selectedBand) {
        ctx.strokeStyle = "#ff0";
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    });
  }

  function getBandAtPos(track, x, y) {
    for (let i = 0; i < track.eqBands.length; i++) {
      const band = track.eqBands[i];
      const bx = freqToX(band.freq);
      const by = gainToY(band.gain);
      if (Math.hypot(bx - x, by - y) < 10) return i;
    }
    return null;
  }

  function updateBandUI() {
    if (selectedBand === null || !selectedTrack) {
      addBandBtn.disabled = !selectedTrack;
      deleteBandBtn.disabled = true;
      bandTypeSelect.disabled = true;
      return;
    }
    addBandBtn.disabled = false;
    deleteBandBtn.disabled = false;
    bandTypeSelect.disabled = false;
    const band = selectedTrack.eqBands[selectedBand];
    bandTypeSelect.value = band.type;
  }

  function rebuildEQ(track) {
    track.eqBands.forEach(band => {
      if (!band.node) {
        band.node = audioContext.createBiquadFilter();
      }
      band.node.type = band.type === "lpf" ? "lowpass" :
                      band.type === "hpf" ? "highpass" :
                      band.type;
      band.node.frequency.value = band.freq;
      band.node.gain.value = band.gain;
      band.node.Q.value = band.Q || 1;
    });
    track.updateAudioGraph();
  }

  function setSelectedTrackUI() {
    [...trackListEl.querySelectorAll(".track")].forEach(div => {
      div.classList.toggle("active", div.textContent === selectedTrack.name);
    });
    selectedBand = null;
    updateBandUI();
  }

  // Event listeners and interaction logic
  canvas.addEventListener("mousedown", (e) => {
    if (!selectedTrack) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const bandIdx = getBandAtPos(selectedTrack, x, y);
    if (bandIdx !== null) {
      draggingBand = bandIdx;
      selectedBand = bandIdx;
      updateBandUI();
      drawEQ();
    }
  });

  canvas.addEventListener("mousemove", (e) => {
    if (draggingBand === null) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const freq = Math.min(Math.max(xToFreq(x), FREQ_MIN), FREQ_MAX);
    const gain = Math.min(Math.max(yToGain(y), GAIN_MIN), GAIN_MAX);

    const band = selectedTrack.eqBands[draggingBand];
    band.freq = freq;
    band.gain = gain;

    rebuildEQ(selectedTrack);
    drawEQ();
    updateBandUI();
  });

  window.addEventListener("mouseup", () => {
    draggingBand = null;
  });

  addBandBtn.addEventListener("click", () => {
    if (!selectedTrack) return;
    selectedTrack.eqBands.push({
      freq: 1000,
      gain: 0,
      Q: 1,
      type: "peaking",
      node: null,
    });
    selectedBand = selectedTrack.eqBands.length - 1;
    rebuildEQ(selectedTrack);
    drawEQ();
    updateBandUI();
  });

  deleteBandBtn.addEventListener("click", () => {
    if (selectedBand === null || !selectedTrack) return;
    selectedTrack.eqBands.splice(selectedBand, 1);
    selectedBand = null;
    rebuildEQ(selectedTrack);
    drawEQ();
    updateBandUI();
  });

  bandTypeSelect.addEventListener("change", () => {
    if (selectedBand === null || !selectedTrack) return;
    selectedTrack.eqBands[selectedBand].type = bandTypeSelect.value;
    rebuildEQ(selectedTrack);
    drawEQ();
  });

  loadTracksBtn.addEventListener("click", async () => {
    loadTracksBtn.disabled = true;
    for (const name of audioFiles) {
      const track = new Track(name);
      try {
        await track.load();
      } catch {
        console.warn(`Failed to load audio file for ${name}`);
      }
      tracks.push(track);

      const trackDiv = document.createElement("div");
      trackDiv.classList.add("track");
      trackDiv.textContent = name;

      // Mute button
      const muteBtn = document.createElement("button");
      muteBtn.textContent = "M";
      muteBtn.classList.add("mute-button");
      muteBtn.title = "Mute";
      muteBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        track.muted = !track.muted;
        muteBtn.classList.toggle("muted", track.muted);
        track.updateAudioGraph();
      });
      trackDiv.appendChild(muteBtn);

      // Solo button
      const soloBtn = document.createElement("button");
      soloBtn.textContent = "S";
      soloBtn.classList.add("solo-button");
      soloBtn.title = "Solo";
      soloBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        track.soloed = !track.soloed;
        soloBtn.classList.toggle("soloed", track.soloed);
        // Solo logic: mute others if any solo active
        const anySolo = tracks.some(t => t.soloed);
        tracks.forEach(t => {
          t.gainNode.gain.value = t.muted || (anySolo && !t.soloed) ? 0 : 1;
        });
      });
      trackDiv.appendChild(soloBtn);

      // Volume slider
      const volSlider = document.createElement("input");
      volSlider.type = "range";
      volSlider.min = 0;
      volSlider.max = 1;
      volSlider.step = 0.01;
      volSlider.value = 1;
      volSlider.classList.add("volume-slider");
      volSlider.title = "Volume";
      volSlider.addEventListener("input", () => {
        track.gainNode.gain.value = volSlider.value;
      });
      trackDiv.appendChild(volSlider);

      trackDiv.addEventListener("click", () => {
        selectedTrack = track;
        setSelectedTrackUI();
        playBtn.disabled = false;
        stopBtn.disabled = !track.playing;
        addBandBtn.disabled = false;
        bandTypeSelect.disabled = false;
        deleteBandBtn.disabled = selectedTrack.eqBands.length === 0;
        updateDynamicsUI();
        drawEQ();
      });

      trackListEl.appendChild(trackDiv);
    }
  });

  playBtn.addEventListener("click", () => {
    if (selectedTrack && !selectedTrack.playing) {
      selectedTrack.play();
      playBtn.disabled = true;
      stopBtn.disabled = false;
    }
  });

  stopBtn.addEventListener("click", () => {
    if (selectedTrack && selectedTrack.playing) {
      selectedTrack.stop();
      playBtn.disabled = false;
      stopBtn.disabled = true;
    }
  });

  // Dynamics selects handlers
  function updateDynamicsUI() {
    if (!selectedTrack) return;
    dynBoxes.forEach((box, idx) => {
      const posSelect = box.querySelector(".dyn-position");
      const typeSelect = box.querySelector(".dyn-type");
      const dyn = selectedTrack.dynamics[idx];

      posSelect.value = dyn.position;
      typeSelect.value = dyn.type;

      posSelect.disabled = false;
      typeSelect.disabled = false;

      posSelect.onchange = () => {
        dyn.position = posSelect.value;
        selectedTrack.updateAudioGraph();
      };
      typeSelect.onchange = () => {
        dyn.type = typeSelect.value;
        selectedTrack.updateAudioGraph();
      };
    });
  }

  // Initial draw
  drawGrid();
});
</script>

</body>
</html>
